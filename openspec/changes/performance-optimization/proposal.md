# Change: 性能优化 - 提升任务执行速度

## Why

当前系统在任务启动和执行过程中存在明显的性能瓶颈，主要体现在：
1. **启动延迟高**：spawn 子进程耗时可能超过 500ms
2. **日志系统开销**：异步写入间隔 500ms，缓冲区 1000 条可能过大，影响响应速度
3. **JSON 解析开销**：parseJSONStream 中存在不必要的正则匹配和 JSON.parse 调用

这些性能问题累积起来，导致用户感知的任务响应速度慢，特别是在频繁执行小任务时，启动开销占比过高。

根据深度分析，进度回调功能已实现但性能影响未量化，日志系统的异步机制可能引入不必要的延迟，JSON 流解析器的实现有优化空间。

## What Changes

### 1. 子进程启动优化
- 分析 spawn() 启动时间瓶颈
- 探索 detached 模式减少等待时间
- 评估进程池复用的可行性（针对支持的后端）
- 优化环境变量和参数传递

### 2. 日志系统性能优化
- 测量 flush 机制的实际性能影响
- 优化缓冲区大小（当前 1000 条可能过大）
- 实现智能 flush：根据日志紧急程度动态调整间隔
- 减少不必要的日志写入

### 3. JSON 流解析优化
- 分析 parseJSONStream 的性能热点
- 优化正则表达式匹配效率
- 减少不必要的字符串操作
- 缓存重复的 JSON.parse 调用

### 4. 性能基准测试
- 建立性能测试套件
- 测量关键路径耗时：启动、执行、解析、日志
- 建立性能基线（baseline）
- 对比优化前后的改进并量化

## Impact

**Affected specs:**
- **MODIFIED**: task-execution（修改现有能力 - 优化子进程管理）
- **MODIFIED**: logging-system（修改现有能力 - 优化日志性能）
- **NEW**: json-stream-parser（新增能力 - JSON 流解析器规范）
- **NEW**: performance-benchmarking（新增能力 - 性能基准测试）

**Affected code:**
- `src/executor.mjs` - 子进程启动和管理优化
- `src/logger.mjs` - 日志系统性能优化
- `src/parser.mjs` - JSON 流解析优化
- `test/performance.test.mjs` - 新建性能基准测试
- `docs/PERFORMANCE.md` - 新建性能文档

**性能目标:**
- 任务启动延迟：从 >500ms 降至 <200ms（60%+ 提升）
- 日志写入不阻塞主流程（异步验证通过）
- JSON 解析开销：< 总耗时的 5%
- 整体执行速度提升：15-25%

**向后兼容性:**
- 完全向后兼容
- 所有优化在现有 API 不变的前提下进行
- 不影响现有功能行为

**技术风险:**
- 中等风险 - 涉及核心执行路径的性能优化
- 需要详细的性能测试验证
- 可能需要多轮迭代才能达到目标
